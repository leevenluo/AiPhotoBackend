# AI Photo Backend - é¡¹ç›®è¯´æ˜

## ğŸ“¦ é¡¹ç›®å·²å®Œæˆ

åŸºäº Node.js + Express å®ç°çš„ AI ç…§ç‰‡ç”Ÿæˆåç«¯ API æœåŠ¡å·²ç»æ­å»ºå®Œæˆï¼

## âœ… å·²å®ç°çš„åŠŸèƒ½

### 1. **ç”¨æˆ·ç³»ç»Ÿ**
- âœ… ç”¨æˆ·ç™»å½•ï¼ˆå¾®ä¿¡å°ç¨‹åºç™»å½•ï¼Œæ”¯æŒæ¨¡æ‹Ÿï¼‰
- âœ… ç”¨æˆ·ç§¯åˆ†ç®¡ç†
- âœ… JWT Token èº«ä»½è®¤è¯

### 2. **ç…§ç‰‡å¤„ç†**
- âœ… ç…§ç‰‡ä¸Šä¼ ï¼ˆæ”¯æŒ jpg/png æ ¼å¼ï¼Œæœ€å¤§ 10MBï¼‰
- âœ… AI ç…§ç‰‡ç”Ÿæˆï¼ˆæ¨¡æ‹Ÿå¼‚æ­¥ç”Ÿæˆè¿‡ç¨‹ï¼‰
- âœ… ç”ŸæˆçŠ¶æ€æŸ¥è¯¢ï¼ˆæ”¯æŒè½®è¯¢ï¼‰
- âœ… ç”Ÿæˆç»“æœè·å–

### 3. **ä½œå“å±•å…**
- âœ… ä½œå“åˆ—è¡¨ï¼ˆæ”¯æŒåˆ†é¡µï¼‰
- âœ… ä½œå“è¯¦æƒ…æŸ¥è¯¢

### 4. **ä¸­é—´ä»¶å’Œå·¥å…·**
- âœ… JWT è®¤è¯ä¸­é—´ä»¶
- âœ… æ–‡ä»¶ä¸Šä¼ ä¸­é—´ä»¶
- âœ… å…¨å±€é”™è¯¯å¤„ç†
- âœ… CORS è·¨åŸŸæ”¯æŒ
- âœ… ç»Ÿä¸€å“åº”æ ¼å¼

### 5. **æµ‹è¯•å’Œæ–‡æ¡£**
- âœ… å®Œæ•´çš„è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬
- âœ… Postman API é›†åˆ
- âœ… è¯¦ç»†çš„å¼€å‘æ–‡æ¡£

## ğŸ“ é¡¹ç›®ç»“æ„

\`\`\`
AiPhotoBackend/
â”œâ”€â”€ src/                          # æºä»£ç ç›®å½•
â”‚   â”œâ”€â”€ app.js                    # åº”ç”¨å…¥å£
â”‚   â”œâ”€â”€ config/                   # é…ç½®æ–‡ä»¶
â”‚   â”‚   â””â”€â”€ index.js
â”‚   â”œâ”€â”€ controllers/              # æ§åˆ¶å™¨å±‚
â”‚   â”‚   â”œâ”€â”€ userController.js     # ç”¨æˆ·æ§åˆ¶å™¨
â”‚   â”‚   â”œâ”€â”€ photoController.js    # ç…§ç‰‡æ§åˆ¶å™¨
â”‚   â”‚   â””â”€â”€ galleryController.js  # å±•å…æ§åˆ¶å™¨
â”‚   â”œâ”€â”€ middleware/               # ä¸­é—´ä»¶
â”‚   â”‚   â”œâ”€â”€ auth.js               # è®¤è¯ä¸­é—´ä»¶
â”‚   â”‚   â”œâ”€â”€ upload.js             # ä¸Šä¼ ä¸­é—´ä»¶
â”‚   â”‚   â””â”€â”€ errorHandler.js       # é”™è¯¯å¤„ç†
â”‚   â”œâ”€â”€ models/                   # æ•°æ®æ¨¡å‹
â”‚   â”‚   â””â”€â”€ storage.js            # å†…å­˜å­˜å‚¨
â”‚   â”œâ”€â”€ routes/                   # è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ user.js
â”‚   â”‚   â”œâ”€â”€ photo.js
â”‚   â”‚   â””â”€â”€ gallery.js
â”‚   â””â”€â”€ utils/                    # å·¥å…·ç±»
â”‚       â”œâ”€â”€ response.js           # å“åº”æ ¼å¼åŒ–
â”‚       â””â”€â”€ jwt.js                # JWT å·¥å…·
â”œâ”€â”€ test/                         # æµ‹è¯•ç›®å½•
â”‚   â””â”€â”€ test.js                   # è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬
â”œâ”€â”€ uploads/                      # æ–‡ä»¶ä¸Šä¼ ç›®å½•ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
â”œâ”€â”€ package.json                  # é¡¹ç›®é…ç½®
â”œâ”€â”€ .gitignore                    # Git å¿½ç•¥æ–‡ä»¶
â”œâ”€â”€ .env.example                  # ç¯å¢ƒå˜é‡ç¤ºä¾‹
â”œâ”€â”€ API.md                        # API æ¥å£æ–‡æ¡£
â”œâ”€â”€ README.md                     # é¡¹ç›®è¯´æ˜
â”œâ”€â”€ SETUP.md                      # å¿«é€Ÿå¯åŠ¨æŒ‡å—
â”œâ”€â”€ é¡¹ç›®è¯´æ˜.md                   # æœ¬æ–‡ä»¶
â”œâ”€â”€ postman_collection.json       # Postman å¯¼å…¥æ–‡ä»¶
â”œâ”€â”€ start.sh                      # å¯åŠ¨è„šæœ¬
â”œâ”€â”€ quick_test.sh                 # å¿«é€Ÿæµ‹è¯•è„šæœ¬
â””â”€â”€ run_all.sh                    # ä¸€é”®å¯åŠ¨æµ‹è¯•è„šæœ¬
\`\`\`

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ–¹å¼ä¸€ï¼šä½¿ç”¨å¯åŠ¨è„šæœ¬ï¼ˆæ¨èï¼‰

\`\`\`bash
# 1. èµ‹äºˆæ‰§è¡Œæƒé™
chmod +x start.sh

# 2. å¯åŠ¨æœåŠ¡
./start.sh
\`\`\`

### æ–¹å¼äºŒï¼šæ‰‹åŠ¨å¯åŠ¨

\`\`\`bash
# 1. å®‰è£…ä¾èµ–
npm install

# 2. å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run dev
\`\`\`

### æ–¹å¼ä¸‰ï¼šä¸€é”®å¯åŠ¨å¹¶æµ‹è¯•

\`\`\`bash
# è‡ªåŠ¨å¯åŠ¨æœåŠ¡å¹¶è¿è¡Œæ‰€æœ‰æµ‹è¯•
chmod +x run_all.sh
./run_all.sh
\`\`\`

## ğŸ§ª æµ‹è¯•æ–¹æ³•

### 1. è‡ªåŠ¨åŒ–æµ‹è¯•ï¼ˆæ¨èï¼‰

\`\`\`bash
# ç»ˆç«¯ 1: å¯åŠ¨æœåŠ¡
npm run dev

# ç»ˆç«¯ 2: è¿è¡Œæµ‹è¯•
npm test
\`\`\`

### 2. å¿«é€Ÿæµ‹è¯•

\`\`\`bash
# ä½¿ç”¨ curl å¿«é€Ÿæµ‹è¯•å„ä¸ªæ¥å£
npm run test:quick
\`\`\`

### 3. ä½¿ç”¨ Postman

1. æ‰“å¼€ Postman
2. å¯¼å…¥ \`postman_collection.json\` æ–‡ä»¶
3. æŒ‰é¡ºåºæ‰§è¡Œè¯·æ±‚ï¼š
   - ç”¨æˆ·ç™»å½• â†’ è‡ªåŠ¨ä¿å­˜ Token
   - å…¶ä»–æ¥å£è‡ªåŠ¨ä½¿ç”¨ Token

### 4. æ‰‹åŠ¨æµ‹è¯•

\`\`\`bash
# 1. ç™»å½•è·å– Token
curl -X POST http://localhost:3000/api/user/login \\
  -H "Content-Type: application/json" \\
  -d '{"code":"test_wx_code_123"}'

# 2. ä½¿ç”¨ Token è®¿é—®æ¥å£ï¼ˆæ›¿æ¢ YOUR_TOKENï¼‰
curl -X GET http://localhost:3000/api/user/points \\
  -H "Authorization: Bearer YOUR_TOKEN"
\`\`\`

## ğŸ“š æ ¸å¿ƒæ¥å£è¯´æ˜

### ç”¨æˆ·æ¥å£

| æ¥å£ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| \`/api/user/login\` | POST | ç”¨æˆ·ç™»å½•ï¼Œè¿”å› Token |
| \`/api/user/points\` | GET | è·å–ç”¨æˆ·ç§¯åˆ† |

### ç…§ç‰‡æ¥å£

| æ¥å£ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| \`/api/photo/upload\` | POST | ä¸Šä¼ ç…§ç‰‡ |
| \`/api/photo/generate\` | POST | ç”Ÿæˆé­”æ³•ç…§ç‰‡ |
| \`/api/photo/status\` | GET | æŸ¥è¯¢ç”ŸæˆçŠ¶æ€ |
| \`/api/photo/result\` | GET | è·å–ç”Ÿæˆç»“æœ |

### å±•å…æ¥å£

| æ¥å£ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| \`/api/gallery/list\` | GET | è·å–ä½œå“åˆ—è¡¨ï¼ˆåˆ†é¡µï¼‰|
| \`/api/gallery/detail\` | GET | è·å–ä½œå“è¯¦æƒ… |

å®Œæ•´çš„æ¥å£æ–‡æ¡£è¯·æŸ¥çœ‹ [API.md](./API.md)

## ğŸ”§ é…ç½®è¯´æ˜

ä¸»è¦é…ç½®åœ¨ \`src/config/index.js\`ï¼š

- **port**: æœåŠ¡ç«¯å£ï¼ˆé»˜è®¤ 3000ï¼‰
- **jwtSecret**: JWT å¯†é’¥ï¼ˆ**ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä¿®æ”¹ï¼**ï¼‰
- **jwtExpire**: Token è¿‡æœŸæ—¶é—´ï¼ˆé»˜è®¤ 7 å¤©ï¼‰
- **upload**: æ–‡ä»¶ä¸Šä¼ é…ç½®
- **wechat**: å¾®ä¿¡å°ç¨‹åºé…ç½®

## ğŸ¯ å…¸å‹ä½¿ç”¨æµç¨‹

### å®Œæ•´çš„ç…§ç‰‡ç”Ÿæˆæµç¨‹

\`\`\`javascript
// 1. ç”¨æˆ·ç™»å½•
POST /api/user/login
{
  "code": "wx_login_code"
}
// è¿”å›: { token, userInfo }

// 2. ä¸Šä¼ ç…§ç‰‡ï¼ˆå¯é€‰ï¼‰
POST /api/photo/upload
Headers: { Authorization: "Bearer {token}" }
FormData: { file, type: "portrait" }
// è¿”å›: { url, fileId }

// 3. ç”Ÿæˆé­”æ³•ç…§ç‰‡
POST /api/photo/generate
Headers: { Authorization: "Bearer {token}" }
{
  "photoUrl": "ä¸Šä¼ è¿”å›çš„ url",
  "prompt": "æç¤ºè¯"
}
// è¿”å›: { taskId, status, estimatedTime }

// 4. è½®è¯¢æŸ¥è¯¢çŠ¶æ€ï¼ˆæ¯ 2-3 ç§’æŸ¥è¯¢ä¸€æ¬¡ï¼‰
GET /api/photo/status?taskId={taskId}
Headers: { Authorization: "Bearer {token}" }
// status: pending/processing/completed/failed

// 5. è·å–æœ€ç»ˆç»“æœ
GET /api/photo/result?taskId={taskId}
Headers: { Authorization: "Bearer {token}" }
// è¿”å›: { resultUrl, thumbnailUrl, prompt, createTime }

// 6. æŸ¥çœ‹ä½œå“å±•å…
GET /api/gallery/list?page=1&pageSize=10
Headers: { Authorization: "Bearer {token}" }
\`\`\`

## ğŸ“Š æ•°æ®è¯´æ˜

### å½“å‰ä½¿ç”¨å†…å­˜å­˜å‚¨

- **ä¼˜ç‚¹**: ç®€å•ã€å¿«é€Ÿã€æ— éœ€é…ç½®æ•°æ®åº“
- **ç¼ºç‚¹**: é‡å¯åæ•°æ®ä¸¢å¤±

### ç”Ÿäº§ç¯å¢ƒå»ºè®®

æ›¿æ¢ \`src/models/storage.js\` ä¸ºçœŸå®æ•°æ®åº“ï¼š

1. **å…³ç³»å‹æ•°æ®åº“**: MySQL, PostgreSQL
   \`\`\`bash
   npm install mysql2 sequelize
   \`\`\`

2. **æ–‡æ¡£å‹æ•°æ®åº“**: MongoDB
   \`\`\`bash
   npm install mongodb mongoose
   \`\`\`

3. **äº‘æ•°æ®åº“**: 
   - è…¾è®¯äº‘ MySQL
   - é˜¿é‡Œäº‘ RDS
   - AWS RDS

## ğŸ¨ AI ç”Ÿæˆé›†æˆ

å½“å‰æ˜¯æ¨¡æ‹Ÿç”Ÿæˆï¼Œå®é™…åº”ç”¨éœ€è¦å¯¹æ¥çœŸå® AI æœåŠ¡ï¼š

### 1. Stable Diffusion
\`\`\`javascript
// åœ¨ photoController.js ä¸­æ›¿æ¢ _simulateGeneration
async function callStableDiffusion(prompt, imageUrl) {
  const response = await axios.post('SD_API_URL', {
    prompt,
    image: imageUrl,
    // å…¶ä»–å‚æ•°...
  });
  return response.data.result_url;
}
\`\`\`

### 2. å…¶ä»– AI æœåŠ¡
- Midjourney API
- DALL-E API
- è…¾è®¯äº‘ AI ç»˜ç”»
- ç™¾åº¦ AI ä½œç”»

## ğŸ” å®‰å…¨å»ºè®®

### ç”Ÿäº§ç¯å¢ƒå¿…åšé¡¹

1. **ä¿®æ”¹ JWT å¯†é’¥**
   \`\`\`javascript
   jwtSecret: process.env.JWT_SECRET || 'your-strong-secret-key'
   \`\`\`

2. **å¯ç”¨ HTTPS**
   \`\`\`javascript
   const https = require('https');
   const fs = require('fs');
   
   const options = {
     key: fs.readFileSync('path/to/key.pem'),
     cert: fs.readFileSync('path/to/cert.pem')
   };
   
   https.createServer(options, app).listen(443);
   \`\`\`

3. **é™åˆ¶ CORS**
   \`\`\`javascript
   app.use(cors({
     origin: ['https://your-frontend-domain.com']
   }));
   \`\`\`

4. **æ·»åŠ è¯·æ±‚é™æµ**
   \`\`\`bash
   npm install express-rate-limit
   \`\`\`

5. **ä½¿ç”¨ç¯å¢ƒå˜é‡**
   \`\`\`bash
   npm install dotenv
   \`\`\`

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **ä½¿ç”¨ PM2 ç®¡ç†è¿›ç¨‹**
   \`\`\`bash
   npm install -g pm2
   pm2 start src/app.js -i max
   \`\`\`

2. **æ·»åŠ  Redis ç¼“å­˜**
   \`\`\`bash
   npm install redis
   \`\`\`

3. **ä½¿ç”¨ CDN å­˜å‚¨æ–‡ä»¶**
   - è…¾è®¯äº‘ COS
   - é˜¿é‡Œäº‘ OSS
   - ä¸ƒç‰›äº‘

4. **æ•°æ®åº“è¿æ¥æ± **
   \`\`\`javascript
   // ä½¿ç”¨ Sequelize æˆ– Mongoose çš„è¿æ¥æ± 
   \`\`\`

## ğŸ› å¸¸è§é—®é¢˜

### 1. ç«¯å£è¢«å ç”¨
\`\`\`bash
# ä¿®æ”¹ç«¯å£
PORT=3001 npm run dev

# æˆ–è€…æ€æ­»å ç”¨è¿›ç¨‹
lsof -ti:3000 | xargs kill -9
\`\`\`

### 2. ä¾èµ–å®‰è£…å¤±è´¥
\`\`\`bash
# æ¸…ç†ç¼“å­˜
npm cache clean --force

# ä½¿ç”¨å›½å†…é•œåƒ
npm install --registry=https://registry.npmmirror.com
\`\`\`

### 3. Token è¿‡æœŸ
é‡æ–°è°ƒç”¨ç™»å½•æ¥å£è·å–æ–°çš„ Token

### 4. æ–‡ä»¶ä¸Šä¼ å¤±è´¥
æ£€æŸ¥ï¼š
- æ–‡ä»¶å¤§å°æ˜¯å¦è¶…è¿‡ 10MB
- æ–‡ä»¶æ ¼å¼æ˜¯å¦ä¸º jpg/png
- uploads ç›®å½•æƒé™æ˜¯å¦æ­£ç¡®

## ğŸ“ æŠ€æœ¯æ”¯æŒ

- æŸ¥çœ‹ [API.md](./API.md) äº†è§£å®Œæ•´ API æ–‡æ¡£
- æŸ¥çœ‹ [README.md](./README.md) äº†è§£é¡¹ç›®è¯¦æƒ…
- æŸ¥çœ‹ [SETUP.md](./SETUP.md) äº†è§£å¿«é€Ÿå¯åŠ¨
- è¿è¡Œæµ‹è¯•è„šæœ¬éªŒè¯åŠŸèƒ½

## ğŸ‰ å¼€å§‹ä½¿ç”¨

\`\`\`bash
# 1. å®‰è£…ä¾èµ–
npm install

# 2. å¯åŠ¨æœåŠ¡
npm run dev

# 3. è¿è¡Œæµ‹è¯•
npm test

# 4. å¼€å§‹å¼€å‘ï¼
\`\`\`

æœåŠ¡å¯åŠ¨åè®¿é—®:
- å¥åº·æ£€æŸ¥: http://localhost:3000/health
- API åŸºç¡€è·¯å¾„: http://localhost:3000/api

ç¥ä½ å¼€å‘é¡ºåˆ©ï¼ğŸš€
